<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Booking | Ride W Me Cabo</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/mobile.css">
  <link rel="icon" type="image/png" href="Images/ridewmelogo.png">

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body class="services-body">

  <!-- HEADER corto -->
  <header class="new-header inner-header">
    <div class="header-overlay"></div>
    <img src="Images/expedition.png" alt="Luxury SUV" class="header-expedition">

    <div class="header-top">
      <div class="logo-text">¬°RIDE W ME!</div>
      <div class="menu-icon" id="openMenu">‚ò∞</div>
    </div>

    <div class="header-content">
      <h1>Book Your Ride</h1>
      <p>Complete the form below to send your reservation.</p>
    </div>
  </header>

  <!-- SIDE MENU -->
  <div id="sideMenu" class="side-menu">
    <div class="close-btn" id="closeMenu">√ó</div>
    <nav class="side-menu-links">
      <a href="index.html">Home</a>
      <a href="services.html">Services</a>
      <a href="booking.html">Book Now</a>
      <a href="contact.html">Contact Us</a>
      <a href="admin.html">Admin Panel</a>
    </nav>
  </div>
  <div id="menuBackdrop" class="menu-backdrop"></div>

  <!-- BOOKING CONTENT -->
  <div class="booking-wrapper">
    <div class="booking-card">
      <h2>Reservation Details</h2>
      <p class="booking-subtitle">Choose your service, select your dates and send your reservation by email and WhatsApp.</p>

      <!-- Resumen -->
      <div class="service-summary">
        <div class="service-summary-title">Selected service</div>
        <div id="selectedServiceName">None selected</div>
        <div id="selectedServicePrice">‚Äî</div>
      </div>

      <form id="bookingForm" class="booking-form">
        <div class="booking-grid">

          <div>
            <label for="name">Full Name</label>
            <input type="text" id="name" required placeholder="Your full name">
          </div>

          <div>
            <label for="email">Email</label>
            <input type="email" id="email" required placeholder="your@email.com">
          </div>

          <div>
            <label for="phone">Phone / WhatsApp</label>
            <input type="tel" id="phone" required placeholder="+52 624...">
          </div>

          <div>
            <label for="serviceType">Service Type</label>
            <select id="serviceType" required>
              <option value="">Select service</option>
              <option value="Airport Transfer">Airport Transfer</option>
              <option value="One Way">One Way</option>
              <option value="Round Trip">Round Trip</option>
              <option value="Open Service (per hour)">Open Service (per hour)</option>
            </select>
          </div>

          <div>
            <label for="passengers">Passengers</label>
            <select id="passengers" required>
              <option value="">Choose</option>
              <option value="1-2">1‚Äì2</option>
              <option value="3-4">3‚Äì4</option>
              <option value="5-6">5‚Äì6</option>
            </select>
          </div>

          <!-- Pickup -->
          <div class="booking-grid-full">
            <label for="pickupPreset">Pickup Location</label>
            <select id="pickupPreset">
              <option value="">Select a popular location</option>
              <option value="Acre Restaurant">Acre Restaurant</option>
              <option value="Cabo del Sol">Cabo del Sol</option>
              <option value="Cabo San Lucas Marina">Cabo San Lucas Marina</option>
              <option value="Cabo San Lucas Downtown">Cabo San Lucas Downtown</option>
              <option value="Edith's">Edith's</option>
              <option value="El Farallon">El Farallon</option>
              <option value="Flora Farms">Flora Farms</option>
              <option value="Jazz on the Rocks at Sunset Point">Jazz on the Rocks at Sunset Point</option>
              <option value="Los Cabos International Airport (SJD)">Los Cabos International Airport (SJD)</option>
              <option value="Medano Beach">Medano Beach</option>
              <option value="Montage Los Cabos">Montage Los Cabos</option>
              <option value="San Jos√© del Cabo Downtown">San Jos√© del Cabo Downtown</option>
              <option value="Sunset Monalisa">Sunset Monalisa</option>
              <option value="Custom">Other / Custom Location</option>
            </select>
            <input type="text" id="pickupCustom" placeholder="Custom pickup address" style="display:none; margin-top:6px;">
          </div>

          <!-- Destination -->
          <div class="booking-grid-full">
            <label for="destinationPreset">Destination</label>
            <select id="destinationPreset">
              <option value="">Select a popular location</option>
              <option value="Acre Restaurant">Acre Restaurant</option>
              <option value="Cabo del Sol">Cabo del Sol</option>
              <option value="Cabo San Lucas Marina">Cabo San Lucas Marina</option>
              <option value="Cabo San Lucas Downtown">Cabo San Lucas Downtown</option>
              <option value="Edith's">Edith's</option>
              <option value="El Farallon">El Farallon</option>
              <option value="Flora Farms">Flora Farms</option>
              <option value="Jazz on the Rocks at Sunset Point">Jazz on the Rocks at Sunset Point</option>
              <option value="Los Cabos International Airport (SJD)">Los Cabos International Airport (SJD)</option>
              <option value="Medano Beach">Medano Beach</option>
              <option value="Montage Los Cabos">Montage Los Cabos</option>
              <option value="San Jos√© del Cabo Downtown">San Jos√© del Cabo Downtown</option>
              <option value="Sunset Monalisa">Sunset Monalisa</option>
              <option value="Custom">Other / Custom Destination</option>
            </select>
            <input type="text" id="destinationCustom" placeholder="Custom destination" style="display:none; margin-top:6px;">
          </div>

          <!-- Dates -->
          <div>
            <label for="date">Date (Departure)</label>
            <input type="text" id="date" placeholder="Select date" readonly required>
          </div>

          <div>
            <label for="time">Time (Departure)</label>
            <input type="time" id="time" required>
          </div>

          <div id="returnDateWrapper" style="display:none;">
            <label for="returnDate">Return Date</label>
            <input type="text" id="returnDate" placeholder="Select return date">
          </div>

          <div id="returnTimeWrapper" style="display:none;">
            <label for="returnTime">Return Time</label>
            <input type="time" id="returnTime">
          </div>

          <div id="hoursWrapper" style="display:none;">
            <label for="hours">Service Hours (Open Service)</label>
            <select id="hours">
              <option value="">Select hours</option>
              <option value="2">2 hours</option>
              <option value="3">3 hours</option>
              <option value="4">4 hours</option>
              <option value="5">5 hours</option>
              <option value="6">6+ hours</option>
            </select>
          </div>

          <!-- Notes -->
          <div class="booking-grid-full">
            <label for="notes">Notes (optional)</label>
            <textarea id="notes" placeholder="Flight number, special requests, hotel room, etc."></textarea>
          </div>

        </div>

        <button type="submit">Confirm & Send Reservation</button>

        <div class="paypal-soon">
          üí≥ Pay with PayPal (coming soon)
        </div>

        <div class="unavailable-box">
          <strong>Unavailable / booked dates:</strong>
          <div id="unavailableList" class="unavailable-list">
            Loading dates...
          </div>
        </div>
      </form>
    </div>
  </div>

  <footer class="site-footer">
    ¬© 2025 Ride W Me Cabo ‚Äî Luxury Transportation in Los Cabos
  </footer>

  <!-- LIBRER√çAS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

  <script>
    // MENU
    const openBtn = document.getElementById("openMenu");
    const closeBtn = document.getElementById("closeMenu");
    const menu = document.getElementById("sideMenu");
    const backdrop = document.getElementById("menuBackdrop");

    if (openBtn && closeBtn && menu && backdrop) {
      openBtn.onclick = () => {
        menu.classList.add("open");
        backdrop.classList.add("show");
        document.body.style.overflow = "hidden";
      };
      closeBtn.onclick = () => {
        menu.classList.remove("open");
        backdrop.classList.remove("show");
        document.body.style.overflow = "auto";
      };
      backdrop.onclick = closeBtn.onclick;
    }

    // BOOKING LOGIC
    const WHATSAPP_NUMBER = "526242426741"; // tu n√∫mero en formato internacional

    emailjs.init("Ed5Qh2Qk81A6fHcRR");

    const SERVICE_PRICES = {
      "Airport Transfer": "$80 USD",
      "One Way": "$100 USD",
      "Round Trip": "$160 USD",
      "Open Service (per hour)": "$50 USD / hr"
    };

    const bookingForm = document.getElementById("bookingForm");
    const serviceTypeEl = document.getElementById("serviceType");
    const pickupPreset = document.getElementById("pickupPreset");
    const pickupCustom = document.getElementById("pickupCustom");
    const destinationPreset = document.getElementById("destinationPreset");
    const destinationCustom = document.getElementById("destinationCustom");
    const returnDateWrapper = document.getElementById("returnDateWrapper");
    const returnTimeWrapper = document.getElementById("returnTimeWrapper");
    const hoursWrapper = document.getElementById("hoursWrapper");
    const unavailableListEl = document.getElementById("unavailableList");
    const selectedServiceNameEl = document.getElementById("selectedServiceName");
    const selectedServicePriceEl = document.getElementById("selectedServicePrice");

    function getDisabledDates() {
      const saved = JSON.parse(localStorage.getItem("reservations")) || [];
      const dates = new Set();
      saved.forEach(r => {
        if (r.date) dates.add(r.date);
        if (r.returnDate) dates.add(r.returnDate);
      });
      return Array.from(dates);
    }

    const disabledDates = getDisabledDates();

    function renderUnavailableList() {
      if (disabledDates.length === 0) {
        unavailableListEl.textContent = "All dates currently available.";
        return;
      }
      unavailableListEl.innerHTML = "";
      disabledDates.forEach(d => {
        const p = document.createElement("div");
        p.textContent = d;
        unavailableListEl.appendChild(p);
      });
    }
    renderUnavailableList();

    const datePicker = flatpickr("#date", {
      dateFormat: "Y-m-d",
      minDate: "today",
      disable: disabledDates
    });

    const returnDatePicker = flatpickr("#returnDate", {
      dateFormat: "Y-m-d",
      minDate: "today",
      disable: disabledDates
    });

    function updateServiceUI() {
      const sv = serviceTypeEl.value;

      if (sv) {
        selectedServiceNameEl.textContent = sv;
        selectedServicePriceEl.textContent = SERVICE_PRICES[sv] || "Price on request";
      } else {
        selectedServiceNameEl.textContent = "None selected";
        selectedServicePriceEl.textContent = "‚Äî";
      }

      if (sv === "Round Trip") {
        returnDateWrapper.style.display = "block";
        returnTimeWrapper.style.display = "block";
        hoursWrapper.style.display = "none";
      } else if (sv === "Open Service (per hour)") {
        hoursWrapper.style.display = "block";
        returnDateWrapper.style.display = "none";
        returnTimeWrapper.style.display = "none";
      } else {
        returnDateWrapper.style.display = "none";
        returnTimeWrapper.style.display = "none";
        hoursWrapper.style.display = "none";
      }
    }

    serviceTypeEl.addEventListener("change", updateServiceUI);

    pickupPreset.addEventListener("change", () => {
      if (pickupPreset.value === "Custom") {
        pickupCustom.style.display = "block";
        pickupCustom.required = true;
      } else {
        pickupCustom.style.display = "none";
        pickupCustom.required = false;
      }
    });

    destinationPreset.addEventListener("change", () => {
      if (destinationPreset.value === "Custom") {
        destinationCustom.style.display = "block";
        destinationCustom.required = true;
      } else {
        destinationCustom.style.display = "none";
        destinationCustom.required = false;
      }
    });

    const urlParams = new URLSearchParams(window.location.search);
    const selectedService = urlParams.get("service");
    if (selectedService) {
      serviceTypeEl.value = selectedService;
      updateServiceUI();
    } else {
      updateServiceUI();
    }

    function showAlert(message, isError = false) {
      const existing = document.querySelector(".custom-alert");
      if (existing) {
        existing.classList.remove("error", "show");
        existing.textContent = message;
        if (isError) existing.classList.add("error");
        setTimeout(() => existing.classList.add("show"), 50);
        setTimeout(() => {
          existing.classList.remove("show");
          setTimeout(() => existing.remove(), 400);
        }, 4000);
        return;
      }

      const a = document.createElement("div");
      a.className = "custom-alert" + (isError ? " error" : "");
      a.textContent = message;
      document.body.appendChild(a);
      setTimeout(() => a.classList.add("show"), 50);
      setTimeout(() => {
        a.classList.remove("show");
        setTimeout(() => a.remove(), 400);
      }, 4000);
    }

    bookingForm.addEventListener("submit", function(e) {
      e.preventDefault();

      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const serviceType = serviceTypeEl.value;
      const passengers = document.getElementById("passengers").value;
      const date = document.getElementById("date").value;
      const time = document.getElementById("time").value;
      const returnDate = document.getElementById("returnDate").value;
      const returnTime = document.getElementById("returnTime").value;
      const hours = document.getElementById("hours").value;
      const notes = document.getElementById("notes").value.trim();

      const pickup = pickupPreset.value === "Custom"
        ? pickupCustom.value.trim()
        : pickupPreset.value;

      const destination = destinationPreset.value === "Custom"
        ? destinationCustom.value.trim()
        : destinationPreset.value;

      if (!name || !email || !phone || !serviceType || !date || !time || !pickup || !destination) {
        showAlert("Please complete all required fields.", true);
        return;
      }

      if (serviceType === "Round Trip" && (!returnDate || !returnTime)) {
        showAlert("Please select both return date and time for Round Trip.", true);
        return;
      }

      const reservation = {
        name,
        email,
        phone,
        serviceType,
        passengers,
        date,
        time,
        pickup,
        destination,
        returnDate: serviceType === "Round Trip" ? returnDate : "",
        returnTime: serviceType === "Round Trip" ? returnTime : "",
        hours: serviceType === "Open Service (per hour)" ? hours : "",
        notes
      };

      let saved = JSON.parse(localStorage.getItem("reservations")) || [];
      saved.push(reservation);
      localStorage.setItem("reservations", JSON.stringify(saved));

      emailjs.send("service_8zcytcr", "template_7tkwggo", reservation)
        .then(() => {
          sendWhatsApp(reservation);
          showAlert("‚úÖ Reservation sent successfully!");
          bookingForm.reset();
          updateServiceUI();
        })
        .catch((err) => {
          console.error("Email send error:", err);
          showAlert("‚ùå Error sending your reservation. Try again.", true);
        });
    });

    function sendWhatsApp(r) {
      let msg = `New Reservation - Ride W Me Cabo%0A%0A` +
        `Name: ${r.name}%0A` +
        `Email: ${r.email}%0A` +
        `Phone: ${r.phone}%0A` +
        `Service: ${r.serviceType}%0A` +
        `Passengers: ${r.passengers}%0A` +
        `Pickup: ${r.pickup}%0A` +
        `Destination: ${r.destination}%0A` +
        `Date: ${r.date} at ${r.time}%0A`;

      if (r.returnDate && r.returnTime) {
        msg += `Return: ${r.returnDate} at ${r.returnTime}%0A`;
      }
      if (r.hours) {
        msg += `Hours: ${r.hours}%0A`;
      }
      if (r.notes) {
        msg += `%0ANotes: ${r.notes}%0A`;
      }

      const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`;
      window.open(url, "_blank");
    }
  </script>
</body>
</html>
